<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax OCR API Runner</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Sarabun:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="styleocr.css">
</head>
<body>
    <button class="home-btn" onclick="window.location.href='landingpage.html'">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="18" height="18">
            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7A1 1 0 003 10h1v7a1 1 0 001 1h4v-4h2v4h4a1 1 0 001-1v-7h1a1 1 0 00.707-1.707l-7-7z"/>
        </svg>
    </button>
    <div class="background-decoration"></div>
    <div class="container">
        <header class="main-header">
            <div class="logo-area">
                <div class="logo-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                        <path
                            d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z" />
                    </svg>
                </div>
                <h1>Tax OCR API</h1>
            </div>
            <p class="subtitle">อัปโหลด PDF/รูปภาพ → รัน workflow → แสดงผล JSON</p>
        </header>
        <main class="app-layout">
            <!-- Upload Section -->
            <section class="card">
                <div class="card-header">
                    <div class="step-indicator">1</div>
                    <h2>อัปโหลดเอกสาร (PDF/รูปภาพ)</h2>
                </div>
                <div class="card-body">
                    <form id="fileupload">
                        <div class="form-group">
                            <label for="file-input">ไฟล์เอกสาร (PDF หรือ รูปภาพ)</label>
                            <input type="file" id="file-input" name="file" accept=".pdf,image/*" required
                                class="input-file">
                        </div>
                        <div class="form-group">
                            <div class="select-wrapper">
                                <label for="career">อาชีพ</label>
                                    <select id="career" name="career">
                                        <option value="">— เลือกอาชีพ —</option>
                                        <option value="employee">พนักงานประจำ</option>
                                        <option value="freelance">ฟรีแลนซ์ / รับจ้างอิสระ / ค้าขายอิสระ</option>
                                        <option value="owner">ลาออกจากพนักงานเอกชน</option>
                                    </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="user_name">ชื่อผู้ใช้</label>
                            <input type="text" id="user_name" name="user_name" placeholder="เช่น นางวงษ์ปัญญา นวนแก้ว">
                        </div>
                        <div class="form-group">
                            <label for="net_income">เงินได้หลังหักค่าใช้จ่ายแล้ว (บาท)</label>
                            <input type="number" id="net_income" name="net_income" min="0" step="1000" required
                                placeholder="0.00">
                        </div>
                        <div class="form-actions">
                            <button class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"
                                    class="btn-icon">
                                    <path fill-rule="evenodd"
                                        d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z"
                                        clip-rule="evenodd" />
                                </svg>
                                ประมวลผล
                            </button>
                        </div>
                        <div id="st" class="status"></div>
                    </form>
                </div>
            </section>
            <!-- Results Section -->
            <section class="card">
                <div class="card-header">
                    <div class="step-indicator">2</div>
                    <h2>ผลลัพธ์การอ่านค่า (Raw JSON)</h2>
                </div>
                <div class="card-body">
                    <pre id="raw">ยังไม่มีข้อมูล...</pre>
                </div>
            </section>
            <!-- Summary Section -->
            <section class="card">
                <div class="card-header">
                    <div class="step-indicator">3</div>
                    <h2>สรุปข้อมูลต่อหน้า</h2>
                </div>
                <div class="card-body">
                    <div id="pages">
                        <div class="empty-state">
                            <p>ผลลัพธ์จะแสดงที่นี่หลังจากประมวลผล</p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    <!-- Floating Button -->
    <button class="floating-next-btn" onclick="window.location.href='manual_input.html'">
        ไปหน้ากรอกข้อมูลลดหย่อนภาษี
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
            <path fill-rule="evenodd"
                d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"
                clip-rule="evenodd" />
        </svg>
    </button>
    <script>
        const fileupload = document.getElementById('fileupload');
        const st = document.getElementById('st');
        const raw = document.getElementById('raw');
        const pages = document.getElementById('pages');
        fileupload.addEventListener('submit', async (e) => {
            e.preventDefault();
            st.textContent = '⏳ กำลังประมวลผล...กรุณารอสักครู่ (ความเร็วในการประมวลขึ้นอยู่กับรายละเอียดของไฟล์)';
            st.style.color = 'var(--accent-gold-dark)';
            raw.textContent = '';
            pages.innerHTML = '';
            const fd = new FormData(fileupload);
            try {
                const res = await fetch('/api/process', { method: 'POST', body: fd });
                const data = await res.json().catch(() => ({ ok: false, error: 'ไม่สามารถ parse JSON' }));
                if (!data.ok) {
                    st.textContent = '❌ ' + (data.error || 'เกิดข้อผิดพลาด');
                    st.style.color = 'var(--error)';
                    return;
                }
                st.textContent = '✅ เสร็จแล้ว';
                st.style.color = 'var(--success)';
                raw.textContent = JSON.stringify(data.result, null, 2);
                renderPages(data.result);
            } catch (err) {
                st.textContent = '❌ เกิดข้อผิดพลาดในการเชื่อมต่อ';
                st.style.color = 'var(--error)';
                console.error(err);
            }
        });
        function renderPages(result) {
            const ps = result.pages || {};
            pages.innerHTML = '';
            if (Object.keys(ps).length === 0) {
                pages.innerHTML = '<div class="empty-state"><p>ไม่พบข้อมูลหน้าเอกสาร</p></div>';
                return;
            }
            Object.keys(ps).sort((a, b) => Number(a) - Number(b)).forEach(k => {
                const d = ps[k] || {};
                const items = Array.isArray(d.items) ? d.items : [];
                // Using the new result-card class from style.css
                pages.insertAdjacentHTML('beforeend', `
                    <div class="result-card">
                        <div class="result-header">
                            <span class="badge">หน้าที่ ${k}</span>
                            <span class="badge" style="background:var(--bg-page)">${d.date ? (d.date.day + '/' + d.date.month + '/' + d.date.year) : 'ไม่พบวันที่'}</span>
                        </div>
                        <div class="result-info">
                            <div><strong>ผู้ขาย:</strong> ${d.seller || '-'}</div>
                            <div><strong>ผู้ซื้อ:</strong> ${d.buyer || '-'}</div>
                            <div><strong>เลขผู้เสียภาษี:</strong> ${d.tax_id || '-'}</div>
                            <div><strong>เงื่อนไขการลดหย่อน:</strong> ${d.final_deduction_rule || '-'}</div>
                            <div><strong>ยอดที่ใช้ได้:</strong> <span style="color:var(--success);font-weight:600">${d.final_deduction ? d.final_deduction + ' บาท' : '-'}</span></div>
                        </div>
                        <div class="result-reason">
                            <strong>หมายเหตุ:</strong> ${d.reason || '-'}
                        </div>
                    </div>
                `);
            });
        }
    </script>
</body>
</html>